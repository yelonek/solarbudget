<!DOCTYPE html>
<html>
<head>
    <title>Solar Energy Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Solar Energy Production Forecast</h1>
    <canvas id="forecastChart"></canvas>
    
    <script>
        const data = {{ solar_data|tojson|safe }};
        const prices = {{ prices|tojson|safe }};
        const dailyTotals = {{ daily_totals|tojson|safe }};

        new Chart('forecastChart', {
            type: 'bar',
            data: {
                labels: data.map(d => {
                    const date = new Date(d.period_end);
                    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }),
                datasets: [{
                    label: 'Solar Production (kWh)',
                    data: data.map(d => d.pv_estimate * 0.25),
                    yAxisID: 'y',
                    backgroundColor: 'rgba(75, 192, 192, 0.5)'
                }, {
                    label: 'Production Range (10th-90th percentile)',
                    data: data.map(d => ({
                        x: new Date(d.period_end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        y0: d.pv_estimate10 * 0.25,
                        y1: d.pv_estimate90 * 0.25
                    })),
                    type: 'line',
                    fill: false,
                    borderWidth: 0,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    yAxisID: 'y'
                }, {
                    label: 'Energy Price (PLN)',
                    data: prices.map(p => p.price),
                    type: 'line',
                    yAxisID: 'y1',
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgb(255, 99, 132)'
                }]
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Solar Production (kWh)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Energy Price (PLN)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label;
                                if (datasetLabel === 'Production Range (10th-90th percentile)') {
                                    const point = context.raw;
                                    return [`10th percentile: ${point.y0.toFixed(2)} kWh`,
                                           `90th percentile: ${point.y1.toFixed(2)} kWh`];
                                }
                                return `${datasetLabel}: ${context.raw.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
